#cloud-config

# Simplified cloud-init for testing Odoo deployment

# Update packages
package_update: true
package_upgrade: true

packages:
  - git
  - docker.io
  - docker-compose
  - curl
  - awscli

# Setup and deploy Odoo
runcmd:
  # Setup Docker Compose v2 if not available
  - |
    if ! command -v docker-compose &> /dev/null; then
      curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
    fi

  # Clone the Odoo repository
  - cd /root
  - git clone -b ${github_branch} https://${github_token}@${github_repo} odoo
  - cd odoo

  # Create .env file with configuration
  - |
    cat > /root/odoo/.env << 'EOF'
    # Odoo Configuration
    ODOO_ADMIN_PASSWORD=${odoo_admin_password}
    ODOO_DB_USER=odoo
    ODOO_DB_PASSWORD=${odoo_db_password}
    ODOO_DB_NAME=${odoo_db_name}

    # SSO Configuration
    ODOO_JWT_SECRET=${odoo_jwt_secret}

    # Odoo Public URL
    ODOO_PUBLIC_URL=https://${domain_name}

    # Orbit Integration
    BACKEND_URL=${backend_url}
    FRONT_URL=${frontend_url}

    # PostgreSQL Configuration
    POSTGRES_DB=postgres
    POSTGRES_USER=odoo
    POSTGRES_PASSWORD=${odoo_db_password}

    # Domain Configuration
    DOMAIN_NAME=${domain_name}
    EOF

  # Configure AWS CLI credentials for S3 access
  - mkdir -p /root/.aws
  - |
    cat > /root/.aws/credentials << 'AWSCREDS'
    [default]
    aws_access_key_id = ${aws_access_key}
    aws_secret_access_key = ${aws_secret_key}
    AWSCREDS
  - |
    cat > /root/.aws/config << 'AWSCONFIG'
    [default]
    region = ${aws_region}
    AWSCONFIG

  # Download template database from S3
  - aws s3 cp s3://odoo-templete-db-s3/odoo_template_03_12_25.zip /tmp/odoo_template_03_12_25.zip

  # Start services
  - cd /root/odoo
  - docker-compose up -d

  # Wait for Odoo to be fully ready (check from inside the container)
  - |
    echo "Waiting for Odoo to be ready..."
    max_attempts=60
    attempt=0
    until docker exec odoo-odoo-1 curl -s http://localhost:8069/web/database/manager > /dev/null 2>&1 || [ $attempt -eq $max_attempts ]; do
      echo "Waiting for Odoo... attempt $attempt/$max_attempts"
      sleep 5
      attempt=$((attempt + 1))
    done
    echo "Odoo is ready!"

  # Copy backup file into Odoo container
  - docker cp /tmp/odoo_template_03_12_25.zip odoo-odoo-1:/tmp/odoo_template_03_12_25.zip

  # Restore database using Odoo's HTTP API (from inside the container)
  - |
    docker exec odoo-odoo-1 curl -X POST \
      -F "master_pwd=${odoo_admin_password}" \
      -F "name=${odoo_db_name}" \
      -F "backup_file=@/tmp/odoo_template_03_12_25.zip" \
      http://localhost:8069/web/database/restore

  # Fix nginx proxy issue automatically
  - sleep 10
  - docker-compose -f /root/odoo/docker-compose.yml up -d --force-recreate nginx

# Write helper files
write_files:
  - path: /root/odoo-info.txt
    content: |
      Odoo Server Information
      =======================
      Domain: ${domain_name}
      Tenant: ${tenant_name}
      Branch: ${github_branch}

      Check status: docker-compose -f /root/odoo/docker-compose.yml ps
      View logs: docker-compose -f /root/odoo/docker-compose.yml logs -f

final_message: |
  ============================================
  Odoo server deployment started!
  ============================================
  Domain: ${domain_name}
  Tenant: ${tenant_name}

  Check deployment status:
  cd /root/odoo && docker-compose ps
  ============================================
