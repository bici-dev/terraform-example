#cloud-config

# This script runs on first boot to set up the Odoo environment

# Update packages
package_update: true
package_upgrade: true

packages:
  - git
  - docker.io
  - docker-compose
  - curl
  - vim
  - htop

# Create necessary directories
runcmd:
  # Setup Docker Compose v2 if not available
  - |
    if ! command -v docker-compose &> /dev/null; then
      curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
    fi

  # Clone the Odoo repository
  - cd /root
  - git clone -b ${github_branch} https://${github_repo} odoo
  - cd odoo

  # Create .env file from template
  - |
    cat > .env << 'EOF'
    # Odoo Configuration
    ODOO_ADMIN_PASSWORD=${odoo_admin_password}
    ODOO_DB_USER=odoo
    ODOO_DB_PASSWORD=${odoo_db_password}
    ODOO_DB_NAME=kk12

    # SSO Configuration
    ODOO_HOST=localhost
    ODOO_PORT=80
    ORBIT_HOST=localhost
    ORBIT_PORT=8080
    ODOO_JWT_SECRET=${odoo_jwt_secret}

    # Odoo Public URL
    ODOO_PUBLIC_URL=https://${domain_name}
    REX_URL=https://${domain_name}

    # Orbit Configuration
    BACKEND_URL=${backend_url}
    FRONTEND_URL=${frontend_url}

    # PostgreSQL Configuration
    POSTGRES_DB=postgres
    POSTGRES_USER=odoo
    POSTGRES_PASSWORD=${odoo_db_password}

    # PgAdmin Configuration
    PGADMIN_DEFAULT_EMAIL=${pgadmin_email}
    PGADMIN_DEFAULT_PASSWORD=${pgadmin_password}

    # SSL Configuration
    CLOUDFLARE_EMAIL=${cloudflare_email}
    CLOUDFLARE_API_KEY=${cloudflare_api_key}
    LETSENCRYPT_EMAIL=${letsencrypt_email}

    # Alertmanager Configuration
    ALERTMANAGER_SMTP_FROM=contactbicidev@gmail.com
    ALERTMANAGER_SMTP_AUTH_USERNAME=contactbicidev@gmail.com
    ALERTMANAGER_SMTP_AUTH_PASSWORD=

    # Domain Configuration
    MODE=production
    DOMAIN_NAME=${domain_name}

    # Prometheus Configuration
    PROMETHEUS_SCRAPE_INTERVAL=45s
    PROMETHEUS_EVAL_INTERVAL=40s
    EOF

  # Create necessary directories
  - mkdir -p /root/odoo/secrets
  - mkdir -p /root/odoo/logs/nginx
  - chmod 700 /root/odoo/secrets

  # Set up log rotation
  - |
    cat > /etc/logrotate.d/odoo << 'LOGROTATE'
    /root/odoo/logs/nginx/*.log {
        daily
        rotate 14
        compress
        delaycompress
        notifempty
        create 0640 root root
        sharedscripts
        postrotate
            docker exec odoo-proxy nginx -s reload > /dev/null 2>&1
        endscript
    }
    LOGROTATE

  # Pull Docker images
  - cd /root/odoo
  - docker-compose pull

  # Build custom Odoo image
  - docker-compose build

  # Start services
  - docker-compose up -d

  # Setup automatic updates (optional - be careful in production)
  # - |
  #   cat > /root/update-odoo.sh << 'UPDATESCRIPT'
  #   #!/bin/bash
  #   cd /root/odoo
  #   git pull origin ${github_branch}
  #   docker-compose pull
  #   docker-compose build
  #   docker-compose up -d
  #   UPDATESCRIPT
  #   chmod +x /root/update-odoo.sh

  # Setup systemd service for Docker Compose
  - |
    cat > /etc/systemd/system/odoo-stack.service << 'SYSTEMDSERVICE'
    [Unit]
    Description=Odoo Docker Compose Stack
    Requires=docker.service
    After=docker.service

    [Service]
    Type=oneshot
    RemainAfterExit=yes
    WorkingDirectory=/root/odoo
    ExecStart=/usr/local/bin/docker-compose up -d
    ExecStop=/usr/local/bin/docker-compose down
    TimeoutStartSec=0

    [Install]
    WantedBy=multi-user.target
    SYSTEMDSERVICE

  # Enable the service
  - systemctl daemon-reload
  - systemctl enable odoo-stack.service

  # Setup monitoring alert
  - |
    cat > /root/health-check.sh << 'HEALTHCHECK'
    #!/bin/bash
    # Check if Odoo is running
    if ! docker ps | grep -q odoo; then
      echo "Odoo container is not running!"
      systemctl restart odoo-stack
    fi
    HEALTHCHECK
    chmod +x /root/health-check.sh

  # Add health check to cron
  - echo "*/5 * * * * /root/health-check.sh" | crontab -

# Write custom files
write_files:
  - path: /root/.bashrc
    append: true
    content: |
      # Odoo aliases
      alias odoo-logs='docker-compose -f /root/odoo/docker-compose.yml logs -f'
      alias odoo-restart='docker-compose -f /root/odoo/docker-compose.yml restart'
      alias odoo-status='docker-compose -f /root/odoo/docker-compose.yml ps'
      alias odoo-update='cd /root/odoo && git pull && docker-compose build && docker-compose up -d'

  - path: /root/README.md
    content: |
      # Odoo Server - ${environment}

      ## Quick Commands

      ```bash
      # View logs
      cd /root/odoo
      docker-compose logs -f

      # Restart services
      docker-compose restart

      # Update from Git
      git pull origin ${github_branch}
      docker-compose build
      docker-compose up -d

      # View running containers
      docker-compose ps

      # Access Odoo shell
      docker-compose exec odoo odoo shell

      # Database backup
      docker-compose exec db pg_dump -U odoo kk12 > backup_$(date +%Y%m%d).sql
      ```

      ## URLs

      - Odoo: https://${domain_name}
      - Prometheus: http://${domain_name}:9090 (internal network only)
      - PgAdmin: http://${domain_name}:5050 (configure nginx to expose)

      ## Configuration

      Environment: ${environment}
      Domain: ${domain_name}
      Backend URL: ${backend_url}
      Frontend URL: ${frontend_url}

      ## Monitoring

      Check service status:
      ```bash
      systemctl status odoo-stack
      ```

      ## Troubleshooting

      If services are not starting:
      ```bash
      cd /root/odoo
      docker-compose down
      docker-compose up -d
      docker-compose logs
      ```

final_message: |
  ============================================
  Odoo ${environment} server is ready!
  ============================================

  IP Address: $(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address)
  Domain: ${domain_name}

  Connect via SSH:
  ssh root@$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address)

  Check logs:
  cd /root/odoo && docker-compose logs -f

  ============================================
