#cloud-config

# Simplified cloud-init for testing Odoo deployment

# Update packages
package_update: true
package_upgrade: true

packages:
  - git
  - docker.io
  - docker-compose
  - curl
  - awscli
  - python3-pip          # ‚úÖ NUEVO: Para instalar odoorpc
  - python3-requests     # ‚úÖ NUEVO: Para hacer requests HTTP

# Setup and deploy Odoo
runcmd:
  # Setup Docker Compose v2 if not available
  - |
    if ! command -v docker-compose &> /dev/null; then
      curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
    fi

  # Clone the Odoo repository
  - cd /root
  - git clone -b ${github_branch} https://${github_token}@${github_repo} odoo
  - cd odoo

  # Create .env file with configuration
  - |
    cat > /root/odoo/.env << 'EOF'
    # Odoo Configuration
    ODOO_ADMIN_PASSWORD=${odoo_admin_password}
    ODOO_ADMIN_EMAIL=${odoo_admin_email}
    ODOO_DB_USER=odoo
    ODOO_DB_PASSWORD=${odoo_db_password}
    ODOO_DB_NAME=${odoo_db_name}

    # SSO Configuration
    ODOO_JWT_SECRET=${odoo_jwt_secret}
    SSL_ENDPOINT_API_KEY=${ssl_endpoint_api_key}

    # Odoo URLs
    ODOO_BASE_URL=${odoo_base_url}
    ODOO_PUBLIC_URL=https://${domain_name}

    # Orbit Integration
    BACKEND_URL=${backend_url}
    FRONT_URL=${frontend_url}

    # PostgreSQL Configuration
    POSTGRES_DB=postgres
    POSTGRES_USER=odoo
    POSTGRES_PASSWORD=${odoo_db_password}

    # Domain Configuration
    DOMAIN_NAME=${domain_name}

    # Nginx Mode (production uses SSL)
    MODE=production

    # Orbit Webhook Configuration
    ORBIT_WEBHOOK_URL=${orbit_webhook_url}
    ORBIT_WEBHOOK_SECRET=${orbit_webhook_secret}
    TENANT_NAME=${tenant_name}
    EOF

  # Configure AWS CLI credentials for S3 and Secrets Manager access
  - mkdir -p /root/.aws
  - |
    cat > /root/.aws/credentials << 'AWSCREDS'
    [default]
    aws_access_key_id = ${aws_access_key}
    aws_secret_access_key = ${aws_secret_key}
    AWSCREDS
  - |
    cat > /root/.aws/config << 'AWSCONFIG'
    [default]
    region = ${aws_region}
    AWSCONFIG

  # Download template database from S3
  - aws s3 cp s3://odoo-templete-db-s3/odoo_template_03_12_25.zip /tmp/odoo_template_03_12_25.zip

  # Fetch SSL certificates from AWS Secrets Manager (Cloudflare Origin Certificates)
  - echo "üîê Fetching SSL certificates from AWS Secrets Manager..."
  - mkdir -p /root/odoo/nginx/ssl
  - |
    aws secretsmanager get-secret-value \
      --secret-id "${ssl_cert_secret_name}" \
      --query SecretString \
      --output text > /root/odoo/nginx/ssl/cloudflare_origin.crt
  - |
    aws secretsmanager get-secret-value \
      --secret-id "${ssl_key_secret_name}" \
      --query SecretString \
      --output text > /root/odoo/nginx/ssl/cloudflare_origin.key
  - chmod 600 /root/odoo/nginx/ssl/cloudflare_origin.key
  - chmod 644 /root/odoo/nginx/ssl/cloudflare_origin.crt
  - echo "‚úÖ SSL certificates fetched and stored in /root/odoo/nginx/ssl/"

  # Start services
  - cd /root/odoo
  - docker-compose up -d

  # Wait for Odoo to be fully ready (check from inside the container)
  - |
    echo "Waiting for Odoo to be ready..."
    max_attempts=60
    attempt=0
    until docker exec odoo-odoo-1 curl -s http://localhost:8069/web/database/manager > /dev/null 2>&1 || [ $attempt -eq $max_attempts ]; do
      echo "Waiting for Odoo... attempt $attempt/$max_attempts"
      sleep 5
      attempt=$((attempt + 1))
    done
    echo "Odoo is ready!"

  # Copy backup file into Odoo container
  - docker cp /tmp/odoo_template_03_12_25.zip odoo-odoo-1:/tmp/odoo_template_03_12_25.zip

  # Restore database using Odoo's HTTP API (from inside the container)
  - |
    docker exec odoo-odoo-1 curl -X POST \
      -F "master_pwd=${odoo_admin_password}" \
      -F "name=${odoo_db_name}" \
      -F "backup_file=@/tmp/odoo_template_03_12_25.zip" \
      http://localhost:8069/web/database/restore

  # Fix nginx proxy issue automatically
  - sleep 10
  - docker-compose -f /root/odoo/docker-compose.yml up -d --force-recreate nginx

  # ‚úÖ NUEVO: Install odoorpc in the Odoo container
  - echo "üì¶ Installing odoorpc in Odoo container..."
  - docker exec odoo-odoo-1 pip3 install --break-system-packages odoorpc

  # ‚úÖ NUEVO: Install odoorpc on host for the setup script
  - echo "üì¶ Installing odoorpc on host..."
  - pip3 install odoorpc

  # ‚úÖ NUEVO: Setup Orbit Integration
  - echo "üîß Setting up Orbit integration..."
  - |
    # Export variables for Python script directly (don't source .env to avoid parsing issues)
    export ODOO_DB_NAME="${odoo_db_name}"
    export ODOO_ADMIN_PASSWORD="${odoo_admin_password}"
    export ODOO_ADMIN_EMAIL="${odoo_admin_email}"
    export TENANT_NAME="${tenant_name}"
    export ODOO_PUBLIC_URL="https://${domain_name}"
    export ORBIT_WEBHOOK_URL="${orbit_webhook_url}"
    export ORBIT_WEBHOOK_SECRET="${orbit_webhook_secret}"

    # Wait for Odoo database to be ready by testing JSON-RPC authentication
    # This mimics what the Python script will do, ensuring database is fully restored
    echo "‚è≥ Waiting for Odoo database and API to be ready..."
    max_attempts=120
    attempt=0
    while [ $attempt -lt $max_attempts ]; do
      # Try to authenticate to the database (same as Python script does)
      response=$(docker exec odoo-odoo-1 curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "{\"jsonrpc\":\"2.0\",\"method\":\"call\",\"params\":{\"service\":\"common\",\"method\":\"authenticate\",\"args\":[\"${odoo_db_name}\",\"${odoo_admin_email}\",\"${odoo_admin_password}\",{}]},\"id\":1}" \
        http://localhost:8069/jsonrpc 2>/dev/null)

      # Check if authentication succeeded (returns a user ID, not false)
      if echo "$response" | grep -q '"result": [0-9]'; then
        echo "‚úÖ Odoo authentication successful! Database is ready."
        sleep 5
        break
      fi
      echo "Waiting for Odoo authentication... attempt $attempt/$max_attempts"
      sleep 5
      attempt=$((attempt + 1))
    done

    if [ $attempt -eq $max_attempts ]; then
      echo "‚ùå Timeout waiting for Odoo database"
      exit 1
    fi

    # Execute Orbit setup script
    echo "üöÄ Executing Orbit integration setup..."
    # Copy script into container and execute it there (where localhost:8069 works)
    docker cp /root/setup_orbit_integration.py odoo-odoo-1:/tmp/setup_orbit_integration.py
    docker exec -e ODOO_DB_NAME="$ODOO_DB_NAME" \
                -e ODOO_ADMIN_PASSWORD="$ODOO_ADMIN_PASSWORD" \
                -e ODOO_ADMIN_EMAIL="$ODOO_ADMIN_EMAIL" \
                -e TENANT_NAME="$TENANT_NAME" \
                -e ODOO_PUBLIC_URL="$ODOO_PUBLIC_URL" \
                -e ORBIT_WEBHOOK_URL="$ORBIT_WEBHOOK_URL" \
                -e ORBIT_WEBHOOK_SECRET="$ORBIT_WEBHOOK_SECRET" \
                odoo-odoo-1 python3 /tmp/setup_orbit_integration.py > /var/log/orbit-setup.log 2>&1

    # Check result
    if [ $? -eq 0 ]; then
      echo "‚úÖ Orbit integration setup completed successfully"
      echo "üìã Check details: /var/log/orbit-setup.log"
    else
      echo "‚ùå Orbit integration setup failed"
      echo "üìã Check errors: /var/log/orbit-setup.log"
    fi

# Write helper files
write_files:
  - path: /root/odoo-info.txt
    content: |
      Odoo Server Information
      =======================
      Domain: ${domain_name}
      Tenant: ${tenant_name}
      Branch: ${github_branch}

      Check status: docker-compose -f /root/odoo/docker-compose.yml ps
      View logs: docker-compose -f /root/odoo/docker-compose.yml logs -f
      Orbit setup log: cat /var/log/orbit-setup.log

  # ‚úÖ Python script for Orbit Integration setup
  - path: /root/setup_orbit_integration.py
    permissions: '0755'
    content: |
      #!/usr/bin/env python3
      import odoorpc
      import requests
      import sys
      import os
      import subprocess
      import json
      import time

      print("\n" + "="*60)
      print("  ORBIT INTEGRATION SETUP")
      print("="*60 + "\n")

      # Validate environment variables
      required_vars = ['ODOO_DB_NAME', 'ODOO_ADMIN_PASSWORD', 'ODOO_ADMIN_EMAIL', 'TENANT_NAME',
                       'ODOO_PUBLIC_URL', 'ORBIT_WEBHOOK_URL', 'ORBIT_WEBHOOK_SECRET']
      missing = [v for v in required_vars if not os.environ.get(v)]

      if missing:
          print(f"‚ùå Missing environment variables: {', '.join(missing)}")
          sys.exit(1)

      odoo_db = os.environ['ODOO_DB_NAME']
      odoo_password = os.environ['ODOO_ADMIN_PASSWORD']
      admin_email = os.environ['ODOO_ADMIN_EMAIL']
      tenant_name = os.environ['TENANT_NAME']
      odoo_url = os.environ['ODOO_PUBLIC_URL']
      webhook_url = os.environ['ORBIT_WEBHOOK_URL']
      webhook_secret = os.environ['ORBIT_WEBHOOK_SECRET']

      try:
          # Connect to Odoo
          print(f"üì° Connecting to Odoo (DB: {odoo_db})...")
          odoo = odoorpc.ODOO('localhost', protocol='jsonrpc', port=8069)
          odoo.login(odoo_db, admin_email, odoo_password)
          print(f"‚úÖ Connected to Odoo as {admin_email} (UID: {odoo.env.uid})")

          # Create API Key
          print("üîë Creating API Key...")

          # Check for existing key
          existing = odoo.execute_kw('res.users.apikeys', 'search',
                                     [[('user_id', '=', odoo.env.uid)]])

          if existing:
              print(f"‚úÖ Found existing API Key (ID: {existing[0]})")
              key_id = existing[0]
          else:
              print("Creating new API Key via HTTP endpoint...")
              session = requests.Session()

              # Authenticate
              auth_response = session.post(
                  'http://localhost:8069/web/session/authenticate',
                  json={
                      'jsonrpc': '2.0',
                      'params': {
                          'db': odoo_db,
                          'login': admin_email,
                          'password': odoo_password
                      }
                  }
              )

              if not auth_response.ok:
                  raise Exception(f"Authentication failed: {auth_response.status_code}")

              # Step 1: Call api_key_wizard
              wizard_response = session.post(
                  'http://localhost:8069/web/dataset/call_kw/res.users/api_key_wizard',
                  json={
                      'jsonrpc': '2.0',
                      'params': {
                          'model': 'res.users',
                          'method': 'api_key_wizard',
                          'args': [odoo.env.uid],
                          'kwargs': {}
                      }
                  }
              )

              wizard_data = wizard_response.json()

              # Step 2: Complete identity check
              if 'result' in wizard_data and isinstance(wizard_data['result'], dict):
                  identity_check_id = wizard_data['result'].get('res_id')

                  if identity_check_id:
                      print(f"üìù Completing security check...")

                      # Set password and run check
                      session.post(
                          'http://localhost:8069/web/dataset/call_kw',
                          json={
                              'jsonrpc': '2.0',
                              'params': {
                                  'model': 'res.users.identitycheck',
                                  'method': 'write',
                                  'args': [[identity_check_id], {'password': odoo_password}],
                                  'kwargs': {}
                              }
                          }
                      )

                      session.post(
                          'http://localhost:8069/web/dataset/call_kw',
                          json={
                              'jsonrpc': '2.0',
                              'params': {
                                  'model': 'res.users.identitycheck',
                                  'method': 'run_check',
                                  'args': [[identity_check_id]],
                                  'kwargs': {}
                              }
                          }
                      )

                      print(f"‚úÖ Security check passed")

                      # Step 3: Complete description wizard
                      session.post(
                          'http://localhost:8069/web/dataset/call_button',
                          json={
                              'jsonrpc': '2.0',
                              'params': {
                                  'model': 'res.users.apikeys.description',
                                  'method': 'make_key',
                                  'args': [[]],
                                  'kwargs': {}
                              }
                          }
                      )

              # Wait for DB commit
              time.sleep(2)

              # Search for the created key
              new_keys = odoo.execute_kw('res.users.apikeys', 'search',
                                          [[('user_id', '=', odoo.env.uid)]],
                                          {'order': 'id desc', 'limit': 1})

              if not new_keys:
                  raise Exception("No API key found after creation wizard")

              key_id = new_keys[0]
              print(f"‚úÖ Created new API Key (ID: {key_id})")

          # Get key from database
          print(f"üì• Retrieving API key from database...")

          db_password = os.environ.get('POSTGRES_PASSWORD', 'odoo')

          result = subprocess.run(
              ['psql', '-h', 'db', '-U', 'odoo', '-d', odoo_db, '-t', '-c',
               f"SELECT key FROM res_users_apikeys WHERE id = {key_id};"],
              capture_output=True, text=True, check=True,
              env={**os.environ, 'PGPASSWORD': db_password}
          )
          api_key = result.stdout.strip()

          if not api_key:
              raise Exception("Failed to retrieve API key from database")

          print(f"‚úÖ Retrieved API key: {api_key[:15]}...")

          # Send webhook
          print(f"üì§ Sending webhook to Orbit...")
          response = requests.post(
              webhook_url,
              json={
                  'tenant_name': tenant_name,
                  'odoo_url': odoo_url,
                  'database': odoo_db,
                  'api_key': api_key,
                  'webhook_secret': webhook_secret
              },
              timeout=30
          )
          response.raise_for_status()

          print(f"‚úÖ Webhook sent successfully: {response.status_code}")
          print("\n" + "="*60)
          print("  SETUP COMPLETED SUCCESSFULLY")
          print("="*60)
          print(f"‚úÖ Tenant: {tenant_name}")
          print(f"‚úÖ URL: {odoo_url}")
          print(f"‚úÖ Database: {odoo_db}")
          print(f"‚úÖ API Key: {api_key[:15]}...")
          print("\nüéâ Orbit integration is ready!\n")
          sys.exit(0)

      except subprocess.CalledProcessError as e:
          print(f"\n‚ùå Database error: {e}")
          if e.stderr:
              print(f"Stderr: {e.stderr}")
          sys.exit(1)
      except Exception as e:
          print(f"\n‚ùå ERROR: {e}")
          import traceback
          traceback.print_exc()
          sys.exit(1)

final_message: |
  ============================================
  Odoo server deployment started!
  ============================================
  Domain: ${domain_name}
  Tenant: ${tenant_name}

  Check deployment status:
  cd /root/odoo && docker-compose ps
  ============================================
